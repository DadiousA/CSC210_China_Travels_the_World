<html>
  <head>
    <title>Wan'U</title>
    <style>
      body{
        background-image:url("options/background.gif"); 
        background-repeat: no-repeat; 
        background-size: 100% 100%;
      }
      i{
        font-size: 70px;
        font-family: "Verdana";
        font-style: normal;
        font-weight: bold;
      }
      .pref-label{
        padding: 5px;
        margin:5px;
        float: left;
        clear: left; 
        font-family: "Verdana";
        font-weight: bold;
        font-size: 20px;
        width: 35%;
        text-align:center;
      }
      .pref-input{
        font-family: "Verdana";
        float: right;
        margin: 5px;
        padding: 5px;
        border: 3px solid #DDDDDD;
        font-size: 20px;
        width: 55%;
        text-align:center;
      }
      #logout:hover {
        background-color:rgba(51,153,255,0.6);
      }
      #deleteaccount:hover{
        background-color:rgba(200,223,255,0.6);
      }
      
    </style>
    
	  <script src="JS-api/jquery-2.1.4.js"></script>
    <script src="JS-api/js.cookie.js"></script>
<!--    <script type="text/javascript" src="js/jssor.slider.mini.js"></script> -->
	 <script src="JS-api/jssor.slider.debug.js"></script>

	
    <script type="text/javascript">

      function reloadJssor(photos, userEmail) {
        var options = { 
          $AutoPlay: true,
          $AutoPlaySteps: 4,
          $SlideDuration: 160,
          $SlideWidth: 300,
          $SlideSpacing: 10,
          $DragOrientation: 1,
          $Cols: 4,
          $ArrowNavigatorOptions: {                      
                    $Class: $JssorArrowNavigator$,              
                    $ChanceToShow: 2,
                    $AutoCenter: 2,
                    $Steps: 1
                  }
        };
        var JssorStruct = "<div id='slider' style='position: relative; margin: 0 auto; top: 0px; left: 0px; width: 1200px; height: 200px; overflow: hidden; visibility: hidden;'><div id='slides' data-u='slides' style='cursor: default; position: relative; top: 0px; left: 0px; width: 1200px; height: 200px; overflow: hidden;'></div></div>";
        var ArrowStruct = "<style> .arrowleft, .arrowright {display: block;position: absolute;width: 55px;height: 55px;cursor: pointer;background: url(options/arrow.png) no-repeat;overflow: hidden;}.arrowleft { background-position: -3px -33px; }.arrowright { background-position: -63px -33px; }.arrowleft:hover { background-position: -123px -33px; }.arrowright:hover { background-position: -183px -33px; }.arrowleft.arrowleftdn { background-position: -243px -33px; }.arrowright.arrowrightdn { background-position: -303px -33px; }</style><span u='arrowleft' class='arrowleft' style='top: 123px; left: 8px;'></span><span u='arrowright' class='arrowright' style='top: 123px; right: 8px;'></span>"
        $('#slider').remove();
        $('#picture-panel').append(JssorStruct);
        for(i=0;i<photos.length;i++){
          $('#slides').append("<div style='display: none;'><img data-u='image' src='user_files/"+userEmail+"/"+photos[i]+"' /></div>");
        }
        $('#slider').append(ArrowStruct);
        var slider = new $JssorSlider$('slider', options);
        slider.$ScaleWidth(slider.$Elmt.parentNode.clientWidth - 50); 
      }
      
      $(document).ready(function() {

        var userEmail = Cookies.get('email');
        var userName = "";

        $.ajax({
          url: "/user_pref/"+userEmail,
          type: "GET",
          dataType : "json",

          success: function( data ) {
            $("#language").val(data.language);
            $("#city").val(data.city);
            userName = data.name;
            $("#header").html("Welcome back, <i>" +userName+'</i>.');
          },
        });

        $.ajax({
          url: "/image/"+userEmail,
          type: "GET",
          dataType : "json",

          success: function( data ) {
            if(data.photos.length != 0)
            reloadJssor(data.photos,userEmail);
          },
        });

        window.setInterval(function() {
          if (Cookies.get('email') == undefined) {
            $.ajax({
              url: "/user/"+userEmail,
              type: "PUT",
              dataType : "text",
              success: function( data ) {
                alert("You need to relog in!");
                window.location.replace('/');
              }
            });
          }
        }, 1000); 

        $("#time").val("Current time: " + new Date()+'.');
        setInterval(function(){$("#time").html("Current time: " + new Date()+'.');}, 1000);

        $("#logout").click(function() {        
          $.ajax({
            url: "/user/"+userEmail,
            type: "PUT",
            dataType : "text",
            success: function( data ) {
                Cookies.remove('email');
                window.location.replace('/');
            }
          });
        });

        $("#deleteaccount").click(function() {        
          var t=confirm("I really want to delete this account.");
          if (t==1){
            $.ajax({
              url: "/user/"+userEmail,
              type: "DELETE",
              dataType : "text",
              success: function( data ) {
                  Cookies.remove('email');
                  window.location.replace('/');
              }
            });
          }
        });

        $( ".pref-input" ).focusout(function() {
          $.ajax({
            url: "/user_pref",
            type: "POST",
            dataType : "text",

            data : {  email: userEmail,
                      language: $("#language").val(),
                      city: $("#city").val(),
                    },
          });
        });

        $('#inputFile').change(function(){
          var formData = new FormData(document.getElementById("photoUpload"));
          $.ajax({
            url: '/image/'+userEmail,
            contentType: false,
            processData: false,
            enctype: "multipart/form-data",
            data: formData,
            type: 'POST',

            success: function( data ) {
              alert('Image Successfully uploaded!');
              var inputFile = $("#inputFile");
              inputFile.replaceWith( inputFile = inputFile.clone( true ) );
              reloadJssor(data.photos,userEmail);
            },
          });
        });




      });
    </script>
  </head>
  
  <body>
    <h1 id='header' style='color: black; font-size: 50px;font-family: "Lucida Console";margin: 20px;'>Welcome</h1>
    
    <div id='time' style='position:absolute; right: 5px;top: 10px;font-size: 15px;'></div>

    <div id='user-panel' style='padding: 20px;height: 20%;position: absolute;width: 40%;top: 30px;right: 5px;'>
      
      <div id='logout-panel' style='margin: auto;clear: left;width: 40%;float: left;opacity: 1;'>
        <img id='logout' src="options/logout.png" style='width: 80%;height: 50%;'>
        <img id='deleteaccount' src="options/deleteaccount.png" style='width: 80%;height: 30%; padding: 10px'>
      </div>
  
      <div id="pref-panel" style='background-color:rgba(50,200,50,0.3);width: 60%;float: left;'>
        <div id='pref-title' style='text-align:center;font-size: 25px;font-family: "Verdana";font-style: normal;font-weight: bold;'>Personal Preferences</div>
        <div id="pref-table">
          <div>
            <label class='pref-label'>language:</label>
            <input type="text" class="pref-input" id="language" placeholder="Enter language">
          </div>
          <div>
            <label class='pref-label'>City:</label>
            <input type="text" class="pref-input" id="city" placeholder="Enter city">
          </div>
        </div>
      </div>
    </div>

    <div id='picture-panel' style="background-color:rgba(50,200,50,0.3);position: relative;width: 100%;top: 150px;height: 50%;">
      <div id='picture-header' style='height: 70px'>
        <div id="blog" style='float: left; font-family: "Arial";font-size: 30px; padding: 15px;font-weight: bold;'>My Album:</div>
      
        <div style='float: right;'>
          <form id="photoUpload">
            <input type="file" id="inputFile"  class="pref-input" name="image" accept="image/*"/> 
            <label style='width: 40%;font-family: "Comic Sans MS";font-size: 30px;padding: 8px;height:17%;'>Add to my album:</label>
          </form>
        </div>
      </div>

      <div id='slider' style='color: black; font-size: 60px;font-family: "Book Antiqua"; text-align:center;'>Ops! You haven't upload any pictures! Start by click "upload"!</div>      
	 </div>     
	  
    <div style='position:relative; top: 20%;'>
	    <div style='color: black; font-size: 30px;font-family: "Book Antiqua"; text-align:center;'>Developer</div>
      <br>
      <div style='color: black; font-size: 20px;font-family: "Book Antiqua"; text-align:center;'>Shengbo Ge &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Yu Wang</div>
	  </div>

  </body>
</html>